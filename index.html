<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>L√≠deres Jhonny Perdomo</title>
  <!-- Favicon -->
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1759868680/Lideres_edfxpn.png" type="image/png">
  <meta name="theme-color" content="#007BFF" />
<link rel="manifest" href="manifest.webmanifest" />
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- DataTables y Bootstrap -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.4/css/responsive.dataTables.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.dataTables.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.bootstrap5.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    body, html {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100%;
      min-height: 100vh;
      background-image: url('https://res.cloudinary.com/dqqeavica/image/upload/v1753538930/FONDO_JHONNY_sugwsj.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }
    .container, main.container {
      width: 100vw !important;
      max-width: 100vw !important;
      min-width: 100vw !important;
      margin: 0 !important;
      padding: 0 !important;
      background: rgba(255,255,255,0.05);
    }
    .titulo-contenedor h1, .titulo-contenedor, h1.titulo-animado {
      font-size: 2rem;
      font-weight: bold;
      color: green;
      text-shadow: 3px 3px 3px #031732;
      animation: rotate 5s infinite linear, stay 10s infinite;
    }
    @keyframes rotate { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
    @keyframes stay { 0%, 25% { transform: rotateY(0deg);} 50%, 75% { transform: rotateY(0deg);} 100% { transform: rotateY(360deg);} }
    .image-container img { max-width: 220px; border-radius: 2px; }
    .copyright { font-size: 0.85em; color: #666; margin-top: 4px; text-align: center; }
    #contactosForm {
      margin: 30px auto 0 auto; max-width: 400px; background: rgba(255,255,255,0.97);
      border-radius: 12px; box-shadow: 0 0 8px rgba(0,0,0,0.2); padding: 24px 16px 10px 16px; display: block;
      transition: opacity .25s ease, transform .25s ease;
    }
    #contactosForm label { font-weight: bold; color: #1257b7; }
    #contactosForm input[type="number"] { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #888; margin-bottom: 7px; margin-top: 2px; }
    .boton-efecto {
      background: linear-gradient(90deg, #1257b7, #3ea652); color: white; border: none; padding: 8px 16px; border-radius: 7px;
      font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s; box-shadow: 1px 2px 4px #ccc;
    }
    .boton-efecto:hover { background: linear-gradient(90deg, #3ea652, #1257b7); }
    .error { color: red; margin-bottom: 8px; text-align: center; font-weight: bold; }
    #tituloLider {
      margin: 20px 0 5px 0; font-size: 1.5em; color: #155724; font-weight: bold; text-align: center; letter-spacing: 1px; text-shadow: 1px 1px 1px #b7e0c3;
    }
    #btnRecargarTabla { margin-left: 10px; margin-top: 5px; font-size: 1.55em; border: none; background: transparent; color: #1e88e5; transition: color 0.2s; }
    #btnRecargarTabla:hover { color: #28a745; background: transparent; border: none; box-shadow: none; }
    #tablaReferidos th, #tablaReferidos td, #tablaReferidos thead th, #tablaReferidos tfoot th {
      text-align: center !important; vertical-align: middle !important;
    }
    #tablaReferidos { width: 100% !important; background: rgba(255,255,255,0.98); border-radius: 10px; margin-top: 20px; }
    .btn-votacion { background-color: #e74c3c !important; color: white !important; border-radius: 6px !important; font-weight: bold; font-size: 1em; padding: 3px 10px !important; margin-right: 3px; }
    .btn-votacion.verde { background-color: #27ae60 !important; }
    .btn-whatsapp { background: #25D366 !important; color: white !important; border-radius: 6px !important; font-size: 1.15em !important; padding: 3px 10px !important; margin-left: 3px; display: inline-flex; align-items: center; justify-content: center; }
    .btn-whatsapp i { font-size: 1.3em !important; color: white !important; vertical-align: middle; }
    .resaltado-lider { background: #e6ffe6 !important; font-weight: bold; transition: background 1.6s; }
    .resaltado-cambio { background: #fff6b2 !important; transition: background 1.6s; }
    .table-responsive { overflow-x: auto; }
    .modal-content { border-radius: 12px; }
    .swal2-popup.swal2-responsive-popup { width: 350px !important; max-width: 95vw; font-size: 15px !important; }
    .icon-btn-header { background: transparent; border: none; cursor: pointer; font-size: 1.5em; vertical-align: middle; color: #1976d2; }
    .icon-btn-header:hover { color: #28a745; }

    #tituloLider { color: #007bff !important; font-weight: bold; font-size: 1.6em; text-align: left; margin: 20px 0 5px 0; letter-spacing: 1px; text-shadow: none !important; }

    .titulo-contenedor { perspective: 1200px; text-align: center; }
    .titulo-animado { font-size: 2rem; font-weight: bold; color: #007BFF; text-shadow: 3px 3px 3px #031732; animation: rotate 5s infinite linear, stay 10s infinite; }
    .descripcion-animado { font-size: 1.5rem; font-weight: bold; color: #007BFF; text-shadow: 3px 3px 3px #A9A9A9; animation: rotate 5s infinite linear, stay 10s infinite; }
    .form-description { text-align: center; font-size: 1em; color: #666; margin-bottom: 20px; }
    h1, h2 { text-align: center; margin-bottom: 10px; }
    .swal2-responsive-popup { max-width: 600px; width: 80%; background-color: white !important; color: black !Important; border: 2px solid #007BFF !important; box-shadow: 0 0 10px rgba(0,0,0,0.5) !important; }
    .swal2-title-custom { color: #007BFF !important; }
    .swal2-content-custom { color: #007BFF !important; }
    .swal2-icon-custom .swal2-icon-content { color: #007BFF !important; }

    /* Estilos espec√≠ficos del formulario */
    #contactosForm { box-shadow: 0 0 16px rgba(0,0,0,0.23); position: relative; }
    #contactosForm .titulo-contenedor h1, #contactosForm .titulo-contenedor h1.titulo-animado {
      color: #007bff !important; text-shadow: none !important; font-size: 2.2rem; letter-spacing: 1px; margin-bottom: 4px; font-weight: bold; text-align: center; animation: none;
    }
    #contactosForm > p:first-of-type { color: #666 !important; text-align: center !important; font-size: 13px !important; margin-top: 0; margin-bottom: 16px; }
    #contactosForm label[for="documento"] { display: block; color: #007bff !important; font-weight: bold; font-size: 1.11em; margin-bottom: 2px; margin-top: 10px; }
    #contactosForm input[type="number"] { padding: 8px 10px; border: 1px solid #bbb; font-size: 1em; margin-bottom: 10px; margin-top: 1px; }
    #contactosForm > p[style*="color: black"] { color: #222 !important; text-align: center !important; font-size: 1.07em; margin-bottom: 14px; margin-top: 0; }
    #contactosForm .boton-efecto {
      width: 100%; margin: 0 auto 12px auto; display: block; background: #fff !important; color: #222 !important;
      border: 2px solid #007bff; border-radius: 7px; font-size: 1.13em; font-weight: bold; box-shadow: 0 2px 8px #b9c7e0;
      transition: background 0.2s, color 0.2s, border 0.2s; padding: 10px 0; text-align: center; letter-spacing: 0.5px;
    }
    #contactosForm .boton-efecto:hover { background: #007bff !important; color: #fff !important; border-color: #007bff; }
    #contactosForm .image-container { display: flex !important; justify-content: center !important; align-items: center !important; margin: 12px 0 0 0; }
    #contactosForm .image-container img { max-width: 220px; width: 220px; display: block; margin: 0 auto; border-radius: 0; box-shadow: none !important; border: none !important; }
    #contactosForm .copyright { width: 100%; text-align: center; font-size: 0.90em; color: #444; margin-top: 6px !important; margin-bottom: 0; padding-bottom: 0; line-height: 1.3; letter-spacing: 0.2px; }
    #contactosForm .copyright a { color: #007bff !important; text-decoration: underline; }
    @media (max-width: 500px) {
      #contactosForm { padding-left: 6px; padding-right: 6px; }
      #contactosForm .image-container img { width: 95vw; max-width: 99vw; }
    }
    #contactosForm > * { margin-left: 0 !important; margin-right: 0 !important; }
    #contactosForm .error { color: red; text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 1em; margin-top: 4px; }
    #contactosForm .image-container + .copyright::before { content: ""; display: block; width: 60%; margin: 10px auto 8px auto; border-bottom: 1.5px solid #ddd; }
    main.container, #tablaReferidos, .table, .table-responsive { }
    #contactosForm { z-index: 10; }
    body, html { align-items: flex-start !important; }

    /* Loader centrado (overlay efecto iOS, 12 barras) */
    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      z-index:9999; backdrop-filter: blur(2px);
      opacity:1; transition: opacity .12s ease;
      will-change: opacity;
    }
    .loader.hidden{
      display:flex !important;
      opacity:0; pointer-events:none;
    }
    .spinner-ios{
      position:relative; width:64px; height:64px;
    }
    .spinner-ios i{
      position:absolute; left:50%; top:50%;
      width:6px; height:18px; margin:-9px 0 0 -3px;
      background:#fff; border-radius:3px;
      opacity:.2;
      animation:iosFade 1.2s linear infinite;
      transform-origin: center center;
    }
    @keyframes iosFade{
      0%, 39%, 100% { opacity:.2; }
      40% { opacity:1; }
    }
    .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
    .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
    .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
    .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
    .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
    .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
    .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
    .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
    .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
    .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
    .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
    .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

    /* Vistas: ocultas por defecto; la activa se muestra */
    .view { display: none; }
    .view.active { display: block; }
    /* Ocultar login al cargar; JS decide qu√© mostrar */
    #contactosForm { display: none !important; }

    /* --- Estilos vista de instalaci√≥n (look Imagen 2) --- */
#view-instalar{
  position: relative;
  min-height: 100vh;
  width: 100vw;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 32px 12px;
}
#view-instalar::before{
  content: "";
  position: fixed;
  inset: 0;
  /* velo blanco suave sobre el fondo para ese efecto lavado */
  background: rgba(255,255,255,.78);
  backdrop-filter: blur(1.5px);
  z-index: -1;
}
.install-hero{
  text-align: center;
  width: min(92vw, 540px);
  margin-inline: auto;
}
.install-hero .hero-title{
  margin: 0 0 14px 0;
  font-size: clamp(1.4rem, 2.5vw + 1rem, 2.2rem);
  letter-spacing: .6px;
  font-weight: 800;
  color: #1e88e5; /* azul */
  text-transform: uppercase;
  text-shadow: 0 2px 0 rgba(0,0,0,.05);
}
.avatar-wrap{
  width: 220px;
  height: 220px;
  margin: 8px auto 14px auto;
  border-radius: 50%;
  padding: 8px;                     /* aro verde */
  background: linear-gradient(135deg, #2e7d32, #67b86a);
  box-shadow: 0 6px 18px rgba(0,0,0,.15), inset 0 0 0 2px rgba(255,255,255,.35);
}
.avatar{
  width: 100%;
  height: 100%;
  display: block;
  border-radius: 50%;
  object-fit: cover;
  border: 8px solid #f4f8f6;        /* aro blanco interno */
  box-shadow: 0 3px 10px rgba(0,0,0,.15);
}
.hashtags{
  list-style: none;
  padding: 0;
  margin: 6px 0 18px 0;
}
.hashtags li{
  margin: 8px 0;
  font-weight: 800;
  color: #111;
}
.btn-install{
  appearance: none;
  border: 0;
  border-radius: 10px;
  padding: 12px 22px;
  font-weight: 800;
  letter-spacing: .2px;
  color: #fff;
  background: linear-gradient(180deg, #1e88e5, #1565c0);
  box-shadow: 0 10px 22px rgba(30,136,229,.35);
  cursor: pointer;
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
}
.btn-install:hover{
  transform: translateY(-1px);
  box-shadow: 0 14px 28px rgba(21,101,192,.40);
  filter: brightness(1.03);
}
.btn-install:active{ transform: translateY(0); }
.btn-install .icon{ margin-left: 6px; }
@media (max-width: 420px){
  .avatar-wrap{ width: 190px; height: 190px; padding: 7px; }
}
  </style>
</head>
<body>
  <!-- Loader iOS -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <!-- Formulario de Validaci√≥n -->
  <form id="contactosForm">
    <div class="titulo-contenedor">
      <h1 class="titulo-animado">INGRESO A LIDERES</h1>
    </div>
    <p style="color: grey; text-align: justify; font-size: 13px;">
      <b>Este Portal es de uso Exclusivo de los L√≠deres.</b><br>
      <i>Equipo del Hacer</i>
    </p>
    <label for="documento"><big><b>Documento:</b></big></label>
    <input type="number" id="documento" name="documento" placeholder="Sin puntos ni espacios" required min="100000" max="9999999999">
    <p style="color: black; text-align: justify;"><b>Ingresa tu Documento para ingresar continuar</b></p>
    <div id="errorMensaje" class="error"></div>
    <button type="button" class="boton-efecto" id="btn-iniciar-sesion" onclick="validarDocumento()"><big><b>Iniciar Sesi√≥n</b></big></button>
    <div class="image-container">
      <img id="imagePreview" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="Preview Image">
    </div>
    <div class="copyright">
      Copyright ¬© <br>
      <a href="https://whatsapp.com/channel/0029VbBEYJ83LdQbOODLO10S" target="_blank"><b>BOT HEART</b></a>
    </div>
  </form>

  <!-- Contenedor de la tabla (oculto al inicio) -->
  <main class="container mt-3" id="mainTableContainer" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top:10px; margin-bottom: 0;">
      <div id="tituloLider"></div>
      <div style="display: flex; align-items: center;">
        <div class="header-right" style="display:flex; flex-direction:column; align-items:flex-end; margin-right:12px;">
          <div class="image-container" style="margin-bottom:2px; max-width:110px;">
            <img id="imagePreview" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="Preview Image" style="max-width:140px;">
          </div>
          <div class="copyright" style="font-size:0.65em;">
            Copyright ¬© <a href="https://wa.me/573103230712" target="_blank"><b>OSCAR POLANIA</b></a>
          </div>
          <button class="boton-efecto" id="btn-cerrar-sesion" onclick="cerrarSesion()" style="background:#C0392B;">Cerrar Sesi√≥n</button>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table id="tablaReferidos" class="table table-striped responsive">
        <thead></thead>
        <tbody></tbody>
        <tfoot></tfoot>
      </table>
    </div>
  </main>

  <!-- Modal Votaci√≥n -->
  <div class="modal fade" id="modalVotacion" tabindex="-1" aria-labelledby="modalVotacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="formVotacion">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalVotacionLabel">Votaci√≥n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div>
              <button type="button" class="boton-efecto" onclick="window.open('https://wsp.registraduria.gov.co/censo/consultar/', '_blank')">Ir a Consultar</button>
            </div>
            <label for="datos_row">Pega aqu√≠ los datos de la Registradur√≠a:</label>
            <textarea class="form-control" id="datos_row" rows="4" placeholder="Pega aqu√≠ la info..." style="margin-bottom:10px;" required></textarea>
            <div class="row g-2">
              <div class="col-md-4"><input id="nuip" class="form-control" type="text" placeholder="NUIP" readonly></div>
              <div class="col-md-4"><input id="departamento" class="form-control" type="text" placeholder="DEPARTAMENTO" readonly></div>
              <div class="col-md-4"><input id="municipio" class="form-control" type="text" placeholder="MUNICIPIO" readonly></div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-md-4"><input id="puesto" class="form-control" type="text" placeholder="PUESTO" readonly></div>
              <div class="col-md-4"><input id="direccion" class="form-control" type="text" placeholder="DIRECCI√ìN" readonly></div>
              <div class="col-md-4"><input id="mesa" class="form-control" type="text" placeholder="MESA" readonly></div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="btnGuardarVotacion" type="submit" class="boton-efecto">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal WhatsApp -->
  <div class="modal fade" id="modalWhatsapp" tabindex="-1" aria-labelledby="modalWhatsappLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="formWhatsapp">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalWhatsappLabel">Enviar WhatsApp</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <label for="mensajeWhatsapp">Mensaje:</label>
            <textarea class="form-control" id="mensajeWhatsapp" rows="4" placeholder="Escribe tu mensaje aqu√≠"></textarea>
          </div>
          <div class="modal-footer">
            <button id="btnEnviarWhatsapp" type="submit" class="boton-efecto" style="background: #25D366;">Enviar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- JS y dependencias -->
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.2/js/dataTables.bootstrap5.js"></script>
  <script src="https://cdn.datatables.net/responsive/3.0.4/js/responsive.dataTables.js"></script>
  <script src="https://cdn.datatables.net/responsive/3.0.4/js/responsive.bootstrap5.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.colVis.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.print.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <script>
    // 1) URL del Web App (actualiza si despliegas nueva versi√≥n)
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzHRNuyX9hdqg-yz3-Q5E6qu5FRbVJqiBkTbbsGGO1GLKCgdCmEQLprMkup8w1n7AqF/exec';

    // 1.1) Sonidos (mismo set que usas en el portal)
    const SOUNDS = {
      question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
      info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
      success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
      error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      resumen: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Charging_clkgcd.mp3',
      login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
      logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
      back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
    };
    function playSoundOnce(url){
      try{
        const a = new Audio(url);
        a.preload = 'auto';
        a.play().catch(()=>{});
      }catch(e){}
    }
    // 1.2) Parchear SweetAlert2 para sonar seg√∫n icono
    if (window.Swal && typeof Swal.fire === 'function'){
      const __fire = Swal.fire.bind(Swal);
      Swal.fire = function(options = {}, ...rest){
        try{
          if (options.soundTag === 'resumen'){
            playSoundOnce(SOUNDS.resumen);
          } else {
            const icon = options.icon || options.type;
            if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
          }
        }catch(e){}
        return __fire(options, ...rest);
      }
    }

    // 1.3) Loader centrado (smart delay)
    const loader = document.getElementById('loader');
    let loadingCount = 0, loaderTimer = null;
    function startLoading(){
      loadingCount++;
      if (loadingCount === 1){
        loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer = null; }, 120);
      }
    }
    function stopLoading(){
      if (loadingCount === 0) return;
      loadingCount--;
      if (loadingCount === 0){
        if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
        loader.classList.add('hidden');
      }
    }

    // 2) Adaptadores API (fetch)
    async function apiValidarLider(documento) {
      startLoading();
      try{
        const url = new URL(WEB_APP_URL);
        url.searchParams.set('action', 'validarLider');
        url.searchParams.set('documento', documento);
        const resp = await fetch(url.toString(), { method: 'GET' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return await resp.json();
      } finally { stopLoading(); }
    }

    async function apiGuardarVotacion({ idxFila, nuip, departamento, municipio, puesto, direccion, mesa }) {
      startLoading();
      try{
        const body = new URLSearchParams({
          action: 'guardarVotacion',
          idxFila: idxFila != null ? String(idxFila) : '',
          nuip, departamento, municipio, puesto, direccion, mesa
        });
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return await resp.json();
      } finally { stopLoading(); }
    }

    // AGREGA esta nueva funci√≥n de API justo debajo de apiGuardarVotacion()

  async function apiEliminarFilas({ documento, nuips }) {
    startLoading();
    try {
      const body = new URLSearchParams({
        action: 'eliminarFilas',
        documento: documento || '',
        nuips: JSON.stringify(nuips || [])
      });
      const resp = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      return await resp.json();
    } finally { stopLoading(); }
  }

    
    // ----- VARIABLES GLOBALES -----
    let nombreLider = "";
    let filasFiltradas = [];
    let encabezados = [];
    let tabla;
    let documentoGuardado = ""; // Para recarga directa
    let deleteMode = false;
  let selectedNuips = new Set();

    // Columnas a ocultar por defecto (√≠ndices de encabezados)
    const columnasOcultas = ["CONTACTO", "REFERENCIA", "LIDER", "DEPARTAMENTO", "PUESTO", "DIRECCION", "MESA", "A√ëO", "MES", "DIA"];

    async function validarDocumento(soloTabla) {
      let documento = "";
      if (soloTabla && documentoGuardado) {
        documento = documentoGuardado;
      } else {
        documento = document.getElementById('documento').value.trim();
      }

      if (!soloTabla) {
        if (documento === "") {
          Swal.fire({ icon: 'warning', title: 'Campo requerido', text: 'Ingresa un documento para validar.', customClass: { popup: 'swal2-responsive-popup' } });
          return;
        }
        if (!/^\d{6,10}$/.test(documento)) {
          Swal.fire({ icon: 'warning', title: 'Formato incorrecto', text: 'Ingresa un N¬∞ de Documento correcto (6 a 10 d√≠gitos).', customClass: { popup: 'swal2-responsive-popup' } });
          return;
        }
        if (navigator.clipboard) { navigator.clipboard.writeText(documento).catch(()=>{}); }
      }

      // Sonido al intentar login
      if (!soloTabla) playSoundOnce(SOUNDS.login);

      Swal.fire({
        title: 'Buscando...',
        html: 'Por favor espera unos segundos.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => { Swal.showLoading(); }
      });

      try {
        const res = await apiValidarLider(documento);
        Swal.close();

        if (!res.existe) {
          Swal.fire({
            icon: 'error',
            title: 'Este Portal es de uso exclusivo de los L√≠deres de Jhonny Perdomo',
            html: 'Ponte en contacto con el Equipo del Hacer.<br><br><div class="copyright">Copyright ¬© <a href="https://whatsapp.com/channel/0029VbBEYJ83LdQbOODLO10S" target="_blank"><b>BOT HEART</b></a></div>',
            width: '90%', padding: '1rem', customClass: { popup: 'swal2-responsive-popup' }
          });
          mostrarFormulario();
          return;
        }

        nombreLider = res.nombreLider;
        documentoGuardado = documento;
        document.getElementById('tituloLider').textContent = "L√≠der " + nombreLider;

        if (!res.tieneReferidos) {
          Swal.fire({
            icon: 'info',
            title: 'No Tienes Referidos',
            html: 'Es importante contar con tu apoyo.<br><br><div class="copyright">Copyright ¬© <a href="https://whatsapp.com/channel/0029VbBEYJ83LdQbOODLO10S" target="_blank"><b>BOT HEART</b></a></div>',
            width: '90%', padding: '1rem', customClass: { popup: 'swal2-responsive-popup' }
          });
          mostrarFormulario();
          return;
        }

        encabezados = res.encabezados;
        filasFiltradas = res.filas;
        ocultarFormulario();
        inicializarTabla();
      } catch (err) {
        Swal.close();
        Swal.fire({ icon:'error', title:'Error de red', text:String(err) });
      }
    }

    function mostrarFormulario() {
      document.getElementById('contactosForm').style.display = 'block';
      document.getElementById('mainTableContainer').style.display = 'none';
      document.getElementById('tituloLider').textContent = "";
    }
    function ocultarFormulario() {
      document.getElementById('contactosForm').style.display = 'none';
      document.getElementById('mainTableContainer').style.display = 'block';
    }
    function cerrarSesion() {
      playSoundOnce(SOUNDS.logout);
      nombreLider = "";
      filasFiltradas = [];
      encabezados = [];
      documentoGuardado = "";
      if (tabla) { tabla.destroy(); }
      mostrarFormulario();
      document.getElementById('documento').value = "";
    }

    function centrarEncabezadosTabla() {
      $('#tablaReferidos thead th, #tablaReferidos tfoot th')
        .removeClass('text-start text-left text-end text-right')
        .addClass('text-center')
        .css('text-align', 'center');
    }

    function inicializarTabla() {
  let colsDT = encabezados.map(header => ({ title: header }));
  colsDT.push({ title: "Votaci√≥n" });
  colsDT.push({ title: "WhatsApp" });
  colsDT.push({ title: "Seleccionar" }); // Columna para checkboxes (oculta por defecto)

  $("#tablaReferidos thead").html("<tr>"+colsDT.map(col=>`<th class='text-center'>${col.title}</th>`).join("")+"</tr>");
  $("#tablaReferidos tfoot").html("<tr>"+colsDT.map(col=>`<th class='text-center'>${col.title}</th>`).join("")+"</tr>");

  // Ajusta data al nuevo n√∫mero de columnas (3 extras)
  let data = filasFiltradas.map(row => [...row, "", "", ""]);

  if ($.fn.DataTable.isDataTable('#tablaReferidos')) {
    $('#tablaReferidos').DataTable().destroy();
    $('#tablaReferidos').empty();
  }

  const ocultarIdxs = columnasOcultas.map(col => encabezados.indexOf(col)).filter(idx=>idx>-1);

  // Botones por rol
  const isAdmin = String(nombreLider || '').trim().toUpperCase() === 'ADMINISTRADOR';
  const colvisButton = { extend: 'colvis', text: 'Filtrar Columnas' };

  const adminExportButtons = [
    { extend: 'copy',  text: '<i class="bi bi-clipboard-fill"></i>', className: 'btn btn-secondary', exportOptions: { columns: ':visible' }, title: 'Referidos ' + nombreLider },
    { extend: 'excel', text: '<i class="bi bi-file-earmark-excel-fill"></i>', className: 'btn btn-success',  exportOptions: { columns: ':visible' }, filename: 'Referidos ' + nombreLider, title: 'Referidos ' + nombreLider },
    { extend: 'pdf',   text: '<i class="bi bi-file-earmark-pdf-fill"></i>',   className: 'btn btn-danger',   exportOptions: { columns: ':visible' }, filename: 'Referidos ' + nombreLider, title: 'Referidos ' + nombreLider },
    { extend: 'print', text: '<i class="bi bi-printer-fill"></i>',            className: 'btn btn-info',     exportOptions: { columns: ':visible' }, title: 'Referidos ' + nombreLider },
    colvisButton
  ];

  // √çndices de las columnas especiales (√∫ltimas tres)
  const idxVotacion = colsDT.length - 3;
  const idxWhatsapp = colsDT.length - 2;
  const idxSeleccion = colsDT.length - 1;

  // Botones nativos de DataTables para Eliminar / Confirmar / Descartar
  const btnEliminar = {
    text: `Eliminar <span class="ms-1 align-middle">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-minus-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
        <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1M6 8.5h4a.5.5 0 0 1 0 1H6a.5.5 0 0 1 0-1"/>
      </svg>
    </span>`,
    className: 'btn btn-outline-danger',
    attr: { id: 'btnEliminarFilas' },
    action: function(e, dt) {
      playSoundOnce(SOUNDS.warning);
      deleteMode = true;
      selectedNuips.clear();
      dt.column(idxSeleccion).visible(true);
      // Oculta "Eliminar" y muestra los otros
      $('#btnEliminarFilas').addClass('d-none');
      $('#btnConfirmarEliminacion, #btnDescartarEliminacion').removeClass('d-none');
      Swal.fire({
        icon: 'warning',
        title: 'Modo eliminaci√≥n',
        text: 'Selecciona una o varias filas para eliminar.',
        timer: 1800,
        showConfirmButton: false,
        customClass: { popup: 'swal2-responsive-popup' }
      });
    }
  };

  const btnConfirmar = {
  text: `Confirmar <span class="ms-1 align-middle">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/>
    </svg>
  </span>`,
  className: 'btn btn-danger d-none',
  attr: { id: 'btnConfirmarEliminacion' },
  action: async function(e, dt) {
    if (selectedNuips.size === 0) {
      Swal.fire({ icon: 'info', title: 'Sin selecci√≥n', text: 'Selecciona al menos una fila.', customClass: { popup: 'swal2-responsive-popup' } });
      return;
    }

    const nuips = Array.from(selectedNuips);

    try {
      Swal.fire({ title: 'Eliminando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      const res = await apiEliminarFilas({ documento: documentoGuardado, nuips });
      Swal.close();

      if (!res || res.ok !== true) {
        throw new Error(res && res.error ? res.error : 'No se pudo eliminar');
      }

      // 1) Quitar filas localmente (feedback inmediato)
      dt.rows(function(idx, data) {
        return nuips.includes(String((data && data[0]) || ''));
      }).remove().draw(false);

      // 2) Salir del modo eliminaci√≥n
      exitDeleteMode(dt);

      // 3) Alerta igual que Guardar (sin recargar tabla)
      playSoundOnce(SOUNDS.success);
      Swal.fire({
        icon: 'success',
        title: 'Fila o filas eliminadas',
        html: (res.eliminadas || 0) + ' fila(s) eliminada(s).<br>Recuerda: algunas columnas pueden estar ocultas. Usa <b>Filtrar Columnas</b> para verlas.',
        timer: 3500,
        showConfirmButton: false,
        customClass: { popup: 'swal2-responsive-popup' }
      });
    } catch (err) {
      Swal.fire({ icon: 'error', title: 'Error al eliminar', text: String(err), customClass: { popup: 'swal2-responsive-popup' } });
    }
  }
};

  const btnDescartar = {
    text: `Descartar <span class="ms-1 align-middle">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-square-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
        <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0 2-2zm3.354 4.646L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708"/>
      </svg>
    </span>`,
    className: 'btn btn-secondary d-none',
    attr: { id: 'btnDescartarEliminacion' },
    action: function(e, dt) {
      playSoundOnce(SOUNDS.back);
      exitDeleteMode(dt);
    }
  };

  const buttonsArr = isAdmin
    ? [...adminExportButtons, btnEliminar, btnConfirmar, btnDescartar]
    : [colvisButton];

  // Crea la tabla
  tabla = $('#tablaReferidos').DataTable({
    language: { url: "//cdn.datatables.net/plug-ins/2.3.2/i18n/es-CO.json" },
    responsive: false,
    dom: 'Blfrtip',
    scrollX: true,
    autoWidth: true,
    pagingType: 'full_numbers',
    lengthMenu: [5, 10, 20, 50, 100],
    columns: colsDT,
    data: data,
    order: [[0, 'asc']],
    buttons: buttonsArr,
    columnDefs: [
      ...ocultarIdxs.map(idx => ({ targets: idx, visible: false })),
      {
        targets: idxVotacion,
        orderable: false,
        searchable: false,
        className: 'text-center',
        render: function(data, type, row, meta) {
          var idxMunicipio = encabezados.indexOf("MUNICIPIO");
          var municipio = (row[idxMunicipio] || "").toString().trim().toUpperCase();
          var colorClass = (municipio === "FLANDES") ? "verde" : "";
          return `<button class="btn-votacion${colorClass ? ' ' + colorClass : ''}" data-row="${meta.row}" onclick="abrirModalVotacion(${meta.row})">Votaci√≥n</button>`;
        }
      },
      {
        targets: idxWhatsapp,
        orderable: false,
        searchable: false,
        className: 'text-center',
        render: function(data, type, row, meta) {
          return `<button class="btn-whatsapp" data-row="${meta.row}" onclick="abrirModalWhatsapp(${meta.row})"><i class="bi bi-whatsapp"></i></button>`;
        }
      },
      {
        targets: idxSeleccion,
        orderable: false,
        searchable: false,
        visible: false, // oculto por defecto
        className: 'text-center',
        render: function(data, type, row, meta) {
          const nuip = (row && row[0] != null) ? String(row[0]) : '';
          const checked = selectedNuips.has(nuip) ? 'checked' : '';
          return `<input type="checkbox" class="form-check-input row-select" data-nuip="${nuip}" ${checked} />`;
        }
      }
    ]
  });

  tabla.off('draw');
  tabla.on('draw', centrarEncabezadosTabla);
  centrarEncabezadosTabla();

  // Delegaci√≥n para checkboxes de filas
  $('#tablaReferidos tbody').off('change', 'input.row-select');
  $('#tablaReferidos tbody').on('change', 'input.row-select', function() {
    const nuip = String(this.dataset.nuip || '');
    if (!nuip) return;
    if (this.checked) selectedNuips.add(nuip);
    else selectedNuips.delete(nuip);
  });

  // Helper para salir del modo eliminaci√≥n (UI + estado)
  function exitDeleteMode(dt) {
    deleteMode = false;
    selectedNuips.clear();
    dt.column(idxSeleccion).visible(false);
    $('#btnConfirmarEliminacion, #btnDescartarEliminacion').addClass('d-none');
    $('#btnEliminarFilas').removeClass('d-none');
  }
}

    // ----- ACCI√ìN VOTACI√ìN -----
    let filaVotacion = null;
    function abrirModalVotacion(idxFila) {
      filaVotacion = idxFila;

      try {
        const row = tabla.row(idxFila).data();
        if (row && row[0]) {
          if (navigator.clipboard) { navigator.clipboard.writeText(row[0].toString()); }
        }
      } catch(e){}

      document.getElementById('datos_row').value = "";
      document.getElementById('nuip').value = "";
      document.getElementById('departamento').value = "";
      document.getElementById('municipio').value = "";
      document.getElementById('puesto').value = "";
      document.getElementById('direccion').value = "";
      document.getElementById('mesa').value = "";

      const row = tabla.row(idxFila).data();
      const idxG = encabezados.indexOf("G");
      const idxH = encabezados.indexOf("H");
      const idxI = encabezados.indexOf("I");
      const idxJ = encabezados.indexOf("J");
      const idxK = encabezados.indexOf("K");
      const idxL = encabezados.indexOf("L");
      if (row[idxG] || row[idxH] || row[idxI] || row[idxJ] || row[idxK] || row[idxL]) {
        document.getElementById('nuip').value = row[idxG] || "";
        document.getElementById('departamento').value = row[idxH] || "";
        document.getElementById('municipio').value = row[idxI] || "";
        document.getElementById('puesto').value = row[idxJ] || "";
        document.getElementById('direccion').value = row[idxK] || "";
        document.getElementById('mesa').value = row[idxL] || "";
        document.getElementById('btnGuardarVotacion').textContent = "Actualizar";
      } else {
        document.getElementById('btnGuardarVotacion').textContent = "Guardar";
      }
      new bootstrap.Modal(document.getElementById('modalVotacion')).show();
    }

    const ENCABEZADOS = ["NUIP", "DEPARTAMENTO", "MUNICIPIO", "PUESTO", "DIRECCI√ìN", "MESA"];
    function limpiarYSeparar(texto) {
      let partes = texto.split(/[\t\n\r]+/).map(x => x.trim()).filter(x => x.length > 0);
      if (partes.length >= 6 && ENCABEZADOS.every(e => partes[0].toUpperCase().includes(e))) partes = partes.slice(1);
      if (partes.length >= 7 && ENCABEZADOS.every((e,i) => partes[i].toUpperCase() === e)) partes = partes.slice(6);
      partes = partes.filter(x => !ENCABEZADOS.includes(x.toUpperCase()));
      if (partes.length > 6) partes[5] = partes.slice(5).join(' ');
      if (partes.length > 6) partes = partes.slice(0,6);
      return partes;
    }
    function intentarAutocompletar() {
      const textarea = document.getElementById('datos_row');
      const pasted = textarea.value.trim();
      const partes = limpiarYSeparar(pasted);
      if (partes.length === 6) {
        document.getElementById('nuip').value = partes[0];
        document.getElementById('departamento').value = partes[1];
        document.getElementById('municipio').value = partes[2];
        document.getElementById('puesto').value = partes[3];
        document.getElementById('direccion').value = partes[4];
        document.getElementById('mesa').value = partes[5];
        textarea.readOnly = true;
      } else {
        textarea.readOnly = false;
      }
    }
    document.getElementById('datos_row').addEventListener('paste', function(e) { setTimeout(intentarAutocompletar, 100); });
    document.getElementById('datos_row').addEventListener('input', intentarAutocompletar);
    document.getElementById('datos_row').addEventListener('blur', intentarAutocompletar);

    // Guardar o actualizar datos de votaci√≥n
    document.getElementById('formVotacion').addEventListener('submit', async function(e){
      e.preventDefault();
      const nuip = document.getElementById('nuip').value.trim();
      const departamento = document.getElementById('departamento').value.trim();
      const municipio = document.getElementById('municipio').value.trim();
      const puesto = document.getElementById('puesto').value.trim();
      const direccion = document.getElementById('direccion').value.trim();
      const mesa = document.getElementById('mesa').value.trim();
      if(!nuip || !departamento || !municipio || !puesto || !direccion || !mesa){
        Swal.fire({icon:'warning',title:'Completa todos los campos',text:'Verifica que la informaci√≥n est√© completa.'});
        return;
      }

      try {
        const res = await apiGuardarVotacion({ idxFila: filaVotacion, nuip, departamento, municipio, puesto, direccion, mesa });
        if (!res || res.ok !== true) throw new Error(res && res.error ? res.error : 'No se pudo guardar');

        // Actualiza local: columna MUNICIPIO (√≠ndice 7) si corresponde a tu estructura
        let nuevaFila = tabla.row(filaVotacion).data().slice();
        nuevaFila[7] = municipio;
        tabla.row(filaVotacion).data(nuevaFila).invalidate().draw(false);

        setTimeout(function() {
          const tr = tabla.row(filaVotacion).node();
          if(tr && tr.children[7]) {
            tr.children[7].classList.add('resaltado-cambio');
            setTimeout(()=>{ tr.children[7].classList.remove('resaltado-cambio'); }, 2000);
          }
        }, 200);

        bootstrap.Modal.getInstance(document.getElementById('modalVotacion')).hide();
        Swal.fire({
          icon: 'success',
          title: '¬°Datos actualizados!',
          html: "Los datos se guardaron correctamente.<br>Recuerda: algunas columnas pueden estar ocultas.<br>Si deseas verlas, usa el bot√≥n <b>Filtrar Columnas</b> en la tabla.",
          timer: 3500,
          showConfirmButton: false
        });
      } catch (err) {
        Swal.fire({ icon:'error', title:'Error al guardar', text:String(err) });
      }
    });

    // ----- ACCI√ìN WHATSAPP -----
    let filaWhatsapp = null;
    function abrirModalWhatsapp(idxFila) {
      filaWhatsapp = idxFila;
      document.getElementById('mensajeWhatsapp').value = "";
      new bootstrap.Modal(document.getElementById('modalWhatsapp')).show();
    }
    document.getElementById('formWhatsapp').addEventListener('submit', function(e){
      e.preventDefault();
      const mensaje = document.getElementById('mensajeWhatsapp').value.trim();
      const rowData = tabla.row(filaWhatsapp).data();
      let numero = (rowData[2] || '').replace(/\D/g, '');
      if (!numero) {
        Swal.fire({icon:'error',title:'No hay n√∫mero de WhatsApp disponible en la fila'});
        return;
      }
      if (navigator.clipboard && mensaje) { navigator.clipboard.writeText(mensaje).catch(()=>{}); }
      var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      var whatsappUrl = isMobile
        ? ('whatsapp://send?phone=' + encodeURIComponent(numero) + '&text=' + encodeURIComponent(mensaje))
        : ('https://api.whatsapp.com/send?phone=' + encodeURIComponent(numero) + '&text=' + encodeURIComponent(mensaje));
      window.open(whatsappUrl, "_blank");
      bootstrap.Modal.getInstance(document.getElementById('modalWhatsapp')).hide();
    });

    // Sonidos en botones clave
    document.getElementById('btn-iniciar-sesion')?.addEventListener('click', ()=> playSoundOnce(SOUNDS.login));
    document.getElementById('btn-cerrar-sesion')?.addEventListener('click', ()=> playSoundOnce(SOUNDS.logout));
  </script>

  <section id="view-instalar" class="view">
  <div class="install-hero">
    <h1 class="hero-title">LIDERES JHONNY</h1>

    <div class="avatar-wrap">
      <img
        class="avatar"
        src="https://res.cloudinary.com/dqqeavica/image/upload/v1759866481/LIDERES_txzx4b.gif"
        alt="Jhonny Perdomo"
      />
    </div>

    <ul class="hashtags">
      <li>#SoyDeFlandes</li>
      <li>#NoParamos</li>
      <li>#SiemprePresentes</li>
    </ul>

    <button class="btn-install" id="btn-instalar-standalone">
      Instalar la App <span class="icon">üì±</span>
    </button>
  </div>
</section>

  
  <script>
  // --- PWA m√≠nimo para instalar desde Android/desktop e instrucciones iOS ---
  let deferredPrompt = null;
  const installButtons = Array.from(document.querySelectorAll('#btn-instalar, #btn-instalar-standalone'));

  function isStandalone(){
    return window.matchMedia('(display-mode: standalone)').matches
        || window.matchMedia('(display-mode: installed)').matches
        || (window.navigator.standalone === true);
  }
  function isIOS(){
    return /(iphone|ipad|ipod)/i.test(navigator.userAgent || '');
  }
  function updateInstallButtonsVisibility(){
    const shouldShow = !isStandalone() && (isIOS() || !!deferredPrompt);
    installButtons.forEach(btn => { if (btn) btn.style.display = shouldShow ? '' : 'none'; });
  }

  // Fallback seguro por si showView a√∫n no est√° disponible
  function activateView(id){
    if (typeof showView === 'function') return showView(id);
    // fallback: activar manualmente la vista
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
    const v = document.getElementById(id);
    if (v) v.classList.add('active');
  }

  // NUEVO: funciones para alternar vistas
  function showInstallView(){
    // Oculta login y tabla, muestra vista de instalaci√≥n
    const form = document.getElementById('contactosForm');
    const table = document.getElementById('mainTableContainer');
    if (form) form.style.display = 'none';
    if (table) table.style.display = 'none';
    activateView('view-instalar');
    updateInstallButtonsVisibility();
  }
  function showLoginView(){
    // Oculta vistas "view" y muestra el login
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
    const form = document.getElementById('contactosForm');
    const table = document.getElementById('mainTableContainer');
    if (form) form.style.display = 'block';
    if (table) table.style.display = 'none';
  }

  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    updateInstallButtonsVisibility();
  });

  window.addEventListener('appinstalled', ()=>{
    deferredPrompt = null;
    updateInstallButtonsVisibility();
    try{ Swal.fire({ icon:'success', title:'¬°App instalada!', timer:1700, showConfirmButton:false }); }catch(_){}
    // Al instalar, saltar al login
    showLoginView();
  });

  installButtons.forEach(btn=>{
    if (!btn) return;
    btn.addEventListener('click', async ()=>{
      // iOS: no hay prompt nativo
      if (isIOS()){
        try{
          Swal.fire({
            icon:'info',
            title:'Instalar en iPhone/iPad',
            html:'1) Toca Compartir (cuadro con flecha).<br>2) Elige "Agregar a pantalla de inicio".<br>3) Confirma "Agregar".'
          });
        }catch(_){
          alert('En iPhone/iPad: Compartir ‚Üí Agregar a pantalla de inicio.');
        }
        return;
      }
      // Android/desktop Chromium
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice.catch(()=>({ outcome:'dismissed' }));
      deferredPrompt = null;
      updateInstallButtonsVisibility();
      if (choice && choice.outcome === 'accepted'){
        try{ Swal.fire({ icon:'success', title:'¬°App instal√°ndose!', timer:1700, showConfirmButton:false }); }catch(_){}
      }
    });
  });

  // Service Worker (usa tu sw.js en la ra√≠z)
  if ('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }

  // Enlace directo: https://tu-sitio/index2.html#instalar
  (function(){
    function openInstallIfHash(){
      if (location.hash === '#instalar') {
        try{ overlay.classList.remove('open'); }catch(_){}
        showInstallView(); // Fuerza la vista de instalaci√≥n si viene con hash
        return;
      }
    }
    window.addEventListener('load', openInstallIfHash);
    window.addEventListener('hashchange', openInstallIfHash);
  })();

  // Inicial: decidir vista al cargar
  window.addEventListener('load', () => {
    if (location.hash === '#instalar') {
      showInstallView();
    } else if (isStandalone()) {
      showLoginView();
    } else {
      showInstallView();
    }
    updateInstallButtonsVisibility();
  });
</script>
</body>
</html>
